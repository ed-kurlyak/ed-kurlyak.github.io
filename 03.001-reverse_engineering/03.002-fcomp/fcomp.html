<!DOCTYPE html>
<html>
<head>
	<title>Сравнение чисел с плавающей запятой в ассемблере - дизасемблирование кода С++</title>

	<meta name="DESCRIPTION" content="Сравнение чисел с плавающей запятой в ассемблере - дизасемблирование кода С++">
	<meta name="KEYWORDS" content="Сравнение чисел с плавающей запятой в ассемблере - дизасемблирование кода С++">

<style type="text/css">
body {
	font-size: 24px;
	font-family: "Consolas";
	background-color: #000;
	color: #ffffff;
}

pre {
	font-size: 24px;
	font-family: "Consolas";
	background-color: #ffffaa;
	color: #000;
	width: max-content;
	min-width: 100%;

}

div.my_selected {
	width: 100%;
	background-color: #ffff55;
	position: relative;
}

a:link, a:visited { color: #aaaaaa; text-decoration: none; font-weight: normal;} 
a:active, a:hover { color: #aaaaaa; text-decoration: underline;}

p {
	text-align: justify;
	margin-right: 20px;
}

</style>	
</head>
<body>

<h3>
Сравнение чисел с плавающей запятой в ассемблере - дизасемблирование кода С++
</h3>

<p>
Код С++
</p>

<img src="./cpp_code1.jpg" width="300" alt="Операция сравнения чисел в С++ - дизасемблирование кода С++">


<p>
Ассемблерный листинг
</p>

<img src="./assembler_code1.jpg" width="800" alt="Операция сравнения чисел в С++ - дизасемблирование кода С++">

<p>
41h это 65 в десятичной и 01000001b в двоичной
</p>

<p>
После выполнения этого кода С++ и выгрузки состояния флагов (инструкция fnstsw) сопроцессора в регистр AX, регистр AH выглядит так:
</p>

<pre>

	ah=00000001b=0000.0001b=0x1h

</pre>

<p>
Что значит "меньше".
</p>

<p>
Сначала в регистр ax записывается состояние флагов сопроцессора при помощи инструкции fnstsw. Затем выполняется команда TEST сравнивая ah и значение 41.
</p>

<p>
Команда TEST выполняет логическое И (т.е. AND) между всеми битами двух операндов. В зависимости от результата могут быть изменены флаги ZF, SF, PF. Инструкция TEST всегда сбрасывает флаги OF и CF.       
</p>

<img src="./fcomp.jpg" width="300" alt="Операция сравнения чисел в С++ - дизасемблирование кода С++">  

<p>
В результате операции fcomp состояние флагов арифметического сопроцессора такое- если больше устанавливает CF=0, ZF=0; если меньше то CF=1, ZF=0, если равно CF=0, ZF=1
</p>

<p>
Таким образом, если "меньше" ah = 0000.0001b, если "равно" ah = 0100.0000b, и если "больше" ah = 0000.0000b.
</p>

<p>
В нашем случае если ZF = 1 или CF = 1 значит «меньше или равно» сравнивается с числом 41h и если выполнить инструкцию TEST то она выдаст результат true, значит выполнится jnz и следовательно будет переход на метку. В регистре AH не может содержаться 41h - это значило бы что число одновременно и меньше и равно. Регистр AH либо равен 40h что значит равно (установлен ZF), либо 1h что значит меньше (установлен CF), либо 0 что значит больше. А сама проверка регистра AH идет со значением 41h.
</p>

<p>
Если ZF = 0 и CF = 0 значит больше (регистр AH содержит все нули), и результат TEST выдаст false то есть перехода jnz не будет на метку.
</p>

Аналогично давайте рассмотрим код наоборот.

<p>
Код на С++.	
</p>

<img src="./cpp_code2.jpg" width="300" alt="Операция сравнения чисел в С++ - дизасемблирование кода С++">

<p>
Ассемблерный листинг.
</p>

<img src="./assembler_code2.jpg" width="800" alt="Операция сравнения чисел в С++ - дизасемблирование кода С++">

<p>
Здесь осуществляется переход jp. Этот переход осуществляется в том случае, если в результате последней операции (в нашем случе это TEST) установлен флаг PF Parity Flag это флаг четности. Флаг четности устанавливается в 1 если в байте четное количество единиц, или если было переполнение- то есть в байте все нули. В числе 41h четное количество единиц, но 40h это установленый флаг ZF (значит равно), а 1h это установленный флаг CF (значит меньше). После выполнения операции TEST регистр AH не может быть 41h (две единицы в байте - это четное количество) - то есть число в результате сравнения одновременно меньше и одновлеменно равно быть не может. Число может быть либо меньше AH = 1h либо равно AH = 40h. А это всегда по одной единице в байте. Значит переход jp осудествляется если число больше- то есть AX содержит все нули (переполнение).
</p>

</body>
</html>
