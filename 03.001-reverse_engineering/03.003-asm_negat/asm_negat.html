<!DOCTYPE html>
<html>
<head>
	<title>Отрицательные числа в ассемблере. Инструкции jmp и call</title>

	<meta name="DESCRIPTION" content="Отрицательные числа в ассемблере. Инструкции jmp и call">
	<meta name="KEYWORDS" content="Отрицательные числа в ассемблере. Инструкции jmp и call">

<style type="text/css">
body {
	font-size: 24px;
	font-family: "Consolas";
	background-color: #000;
	color: #ffffff;
}

pre {
	font-size: 24px;
	font-family: "Consolas";
	background-color: #ffffaa;
	color: #000;
}

div.my_selected {
	width: 100%;
	background-color: #ffff55;
	position: relative;
}

a:link, a:visited { color: #aaaaaa; text-decoration: none; font-weight: normal;} 
a:active, a:hover { color: #aaaaaa; text-decoration: underline;}

p {
	text-align: justify;
	margin-right: 20px;
}

</style>	
</head>
<body>

<h3>
Отрицательные числа в ассемблере. Инструкции jmp и call
</h3>

<p>
Данный проект разрабатывался на С++ для Visual Studio, в настройках проекта было указано Linker->General->Enable Incremental Linking->Yes
</p>

<p>
Что бы положительное число преобразовать в отрицательное или отрицательное число преобразовать в положительное небходимо выполнить следующие шаги:	
</p>


<ol>
<li>Есть число
<li>Выполнить операцию NOT
<li>Добавить до числа единицу 1	
</ol>

<p>Как выполнить операцию NOT - можно запустить кулькулятор Windows, перейти в режим Программист и нажать кнопку Not. Или другой способ. К примеру есть отрицательное шестнадцатеричное число FE 4A. Отнимаем FF FF - FE 4A (то есть инвертируем) получается 0x1B5, добавляем 1 и будет 0x1B6 - это и будет положительнео число которое соответсвтвует отрицательному FE 4A.</p>

<p>
Отрицательные числа в ассемблере представляются при помощи операции, которая называется "дополнение до двух". К примеру у нас есть ассемблерный код в IDA, который вызывет функцию func1 и как видим у инструкции call адрес 0x00411279:
</p>

<img src="./asm1.jpg" width="800" alt="Отрицательные числа в ассемблере">

<p>
В hex виде это выглядит как E8 4A FE FF FF:
</p>

<img src="./asm2.jpg" width="800" alt="Отрицательные числа в ассемблере">

<p>
Где E8 это код инструкции call, а FE 4A само смещение на которое надо перейти. Причем как видим смещение отрицательное - в старшем разряде F, а это значит старший разряд двоичного числа содержит единицу- признак отрицательного числа.	
</p>

<p>
И вот куда мы переходим по инструкции call, на адрес 0x004110C8:	
</p>

<img src="./asm3.jpg" width="800" alt="Отрицательные числа в ассемблере">

<p>
Теперь давайте возьмем адрес после инструкции call, это будет 0x0041127E. Отнимем от этого значения адрес куда мы должны перейти 0x004110C8. Для простоты возьмем так:	
</p>

<pre>

	0x27E - 0x0C8 = 1B6
	
</pre>

<p>
Получилось число 0x1B6 в шестнадцатеричном виде. Теперь проверим наши расчеты. Инструкция call в шестнадцатеричном виде выглядит E8 4A FE FF FF, где E8 это сама инструкция а FE 4A отрицательные смещение куда надо перейти (как понятно отрицательное смещение). Переведем это отрицательное число в обычный вид, в положительное число, используя дополнение до двух, для этого требуется запустить калькулятор Windows и перейти в режим Программист. 
</p>

<ol>
<li> Введем в калькулятор отрицательное шестнадцатеричное число FE 4A
<li> Нажмем в окне калькулятора операцию Not (инвертирование)
<li> Добавим до результата единицу 1
<li> Получили результат 0x1B6 как мы и вычислили смещение при помощи отнимания выше
</ol>

<p>
Положтельные числа переводятся в отрицательные таким же методом - дополнения до двух. К примеру нам нужно получить минус 1, т.е. -1:
</p>

<ol>
<li>В окне калькулятора введем 1
<li>В окне калькулятора нажимаем Not и получаем FFFFFFFFFFFFFFFE
<li>До результата добавляем 1 и получаем FFFFFFFFFFFFFFFF что значит -1
</ol>

<p>
То есть в ассемблере смещение отсчитывается от адреса после инструкции call или jmp. Например продолжим с нашей функцией func1.	
</p>

<img src="./asm4.jpg" width="800" alt="Отрицательные числа в ассемблере">

<p>
В шестнадцатеричном окне IDA E9 обозначает саму инструкцию jmp, смещение для jmp равно 0x183 (положительное смещение), т.е. это выглядит так:	
</p>

<img src="./asm5.jpg" width="800" alt="Отрицательные числа в ассемблере">

<p>
И вот куда мы должны перейти, на адрес 0x00411250:	
</p>

<img src="./asm6.jpg" width="800" alt="Отрицательные числа в ассемблере">

<p>
Следующая инструкция после jmp имеет адрес 0x004110CD, возьмем калькулятор Windows и отнимем ее от адреса куда мы должны перейти 0x00411250, т.е.:
</p>

<pre>

0x250 - 0x0CD = 0x183
	
</pre>

<p>
Таким образом инструкции call или jmp отсчитывают свое смещение перехода начиная от адреса следующей за ними инструкции.
</p>

</body>
</html>
